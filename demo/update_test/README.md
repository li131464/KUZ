# 在线更新测试项目

这是一个演示PyQt5应用在线全量更新功能的测试项目，技术栈完全符合您的实际项目。

## 📋 项目结构

```
update_test/
├── server/                 # 服务端（FastAPI）
│   ├── start.py           # 服务器启动文件
│   ├── functions/         # 功能模块
│   │   ├── version_manager.py  # 版本管理
│   │   └── file_manager.py     # 文件管理
│   ├── config.json        # 服务端配置
│   └── releases/          # 发布包存储
│       ├── v1.0.0/        # v1.0.0版本包
│       └── v1.1.0/        # v1.1.0版本包
├── client/                # 客户端（PyQt5）
│   ├── app.py            # 主应用程序
│   ├── version.txt       # 当前版本号
│   ├── manipulate/       # 操作模块
│   │   ├── api_client.py      # API客户端
│   │   ├── update_manager.py  # 更新管理器
│   │   ├── download_manager.py # 下载管理器
│   │   ├── installer.py       # 安装器
│   │   └── update_dialog.py   # 更新对话框
│   ├── config/           # 配置文件
│   │   └── update_config.json
│   └── temp/             # 临时文件目录
├── v1.1.0_app.py         # v1.1.0版本的应用文件
└── create_update_packages.py  # 打包脚本
```

## 🚀 快速开始

### 第一步：启动服务端

请您执行以下命令启动服务端：

```bash
cd server
python start.py
```

服务端将在 `http://127.0.0.1:8000` 启动，您应该看到：
- ✅ 服务器启动成功的消息
- 📋 版本信息加载完成
- 🌐 API服务可用

### 第二步：启动客户端

请您在新的命令行窗口中执行：

```bash
cd client
python app.py
```

客户端将启动并显示：
- 🎯 当前版本：v1.0.0（蓝色主题）
- 🔢 计数器功能（只有+1按钮）
- 🔄 更新检查功能

### 第三步：测试强制更新流程

1. **自动检查更新**：客户端启动3秒后自动检查更新
2. **发现强制更新**：系统检测到v1.1.0需要强制更新
3. **强制更新对话框**：显示版本对比和更新内容，只有"立即更新"和"退出应用"两个选项
4. **用户选择**：
   - 选择"立即更新"：开始下载和安装过程
   - 选择"退出应用"：直接关闭应用程序
5. **下载进度**：显示下载进度和状态
6. **安装更新**：自动解压和替换文件
7. **重启应用**：应用自动重启完成更新

## 🎯 测试场景

### 场景1：强制更新流程
- 启动v1.0.0客户端
- 等待自动更新检查
- 系统显示强制更新对话框
- 选择"立即更新"完成更新
- 验证新功能（-1按钮、关于对话框、绿色主题）

### 场景2：手动检查更新
- 点击"检查更新"按钮
- 验证更新检查逻辑
- 确认强制更新对话框显示

### 场景3：拒绝更新
- 在强制更新对话框中选择"退出应用"
- 验证应用直接关闭

## 📊 版本对比

| 功能 | v1.0.0 | v1.1.0 |
|------|--------|--------|
| 计数器+1 | ✅ | ✅ |
| 计数器-1 | ❌ | ✅ (新增) |
| 关于对话框 | ❌ | ✅ (新增) |
| 主题颜色 | 蓝色 | 绿色 (更新) |
| 在线更新 | ✅ | ✅ |

## 🛠️ 技术特性

### 服务端特性
- **FastAPI框架**：与您的项目一致
- **版本管理**：支持多版本并存
- **文件服务**：安全的文件下载
- **API接口**：RESTful设计

### 客户端特性
- **PyQt5界面**：与您的项目一致
- **qfluentwidgets**：可选的现代UI组件
- **异步下载**：支持断点续传
- **文件校验**：SHA256完整性验证
- **自动重启**：无缝更新体验

### 更新机制
- **强制更新**：检测到新版本必须更新或退出
- **全量更新**：完整文件替换
- **版本检查**：自动和手动检查
- **进度显示**：实时下载进度
- **错误处理**：完善的异常处理
- **回滚支持**：失败时恢复备份

## 🔧 配置说明

### 服务端配置 (server/config.json)
```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8000
  },
  "versions": {
    "latest": "1.1.0",
    "supported": ["1.0.0", "1.1.0"],
    "force_update_from": "1.0.0"
  }
}
```

### 客户端配置 (client/config/update_config.json)
```json
{
  "update_server": {
    "base_url": "http://127.0.0.1:8000",
    "timeout": 30
  },
  "check_settings": {
    "auto_check": true,
    "check_interval": 86400,
    "check_on_startup": true
  }
}
```

## 📝 测试日志

测试过程中，您可以观察到：

### 服务端日志
- API请求记录
- 版本检查日志
- 文件下载记录

### 客户端日志
- 更新检查状态
- 下载进度信息
- 安装过程记录

## ⚠️ 注意事项

1. **端口占用**：确保8000端口未被占用
2. **防火墙**：可能需要允许Python访问网络
3. **权限问题**：确保有文件写入权限
4. **依赖安装**：需要安装PyQt5和requests等依赖

## 🎉 测试成功标志

测试成功的标志：
1. ✅ 服务端正常启动并显示版本信息
2. ✅ 客户端启动显示v1.0.0蓝色界面
3. ✅ 自动检测到v1.1.0强制更新
4. ✅ 强制更新对话框正确显示（只有"立即更新"和"退出应用"按钮）
5. ✅ 选择"立即更新"后下载和安装过程无错误
6. ✅ 选择"退出应用"后应用程序直接关闭
7. ✅ 更新完成后重启显示v1.1.0绿色界面和新功能

---

**祝您测试愉快！** 🚀

如有任何问题，请检查控制台日志输出。
