# 在线更新测试项目设计说明

## 项目概述

基于**方案1全量更新**，设计一个简化的PyQt5在线更新测试项目。该项目将演示完整的在线更新流程，包括版本检查、下载更新包、安装更新等核心功能。

## 项目结构

```
demo/
├── ref/                          # 参考文档目录
│   ├── 方案1全量.md
│   ├── 方案2增量.md  
│   ├── 方案3全量.md
│   └── 测试项目设计说明.md
├── update_test/                  # 测试项目根目录
│   ├── server/                   # 服务端（后端，模仿0902_leo_server结构）
│   │   ├── start.py             # FastAPI服务器（与您的start.py结构一致）
│   │   ├── functions/           # 功能模块目录
│   │   │   ├── __init__.py
│   │   │   ├── version_manager.py   # 版本管理功能
│   │   │   └── file_manager.py      # 文件管理功能
│   │   ├── releases/            # 发布包存储目录
│   │   │   ├── v1.0.0/
│   │   │   │   ├── app_v1.0.0.zip
│   │   │   │   └── manifest.json
│   │   │   ├── v1.1.0/
│   │   │   └── latest/
│   │   └── config.json          # 服务端配置
│   └── client/                   # 客户端（前端，模仿0902_leo_client结构）
│       ├── app.py               # 主应用程序（与您的app.py结构一致）
│       ├── manipulate/          # 操作模块目录（模仿您的manipulate结构）
│       │   ├── __init__.py
│       │   ├── api_client.py        # API客户端（复用您的api_client.py逻辑）
│       │   ├── update_manager.py    # 更新管理器
│       │   ├── download_manager.py  # 下载管理器
│       │   └── installer.py         # 安装器
│       ├── public/              # 资源文件目录（与您的public结构一致）
│       │   └── logo.png         # 应用图标
│       ├── config/
│       │   └── update_config.json   # 更新配置文件
│       ├── temp/                # 临时文件目录
│       └── version.txt          # 当前版本号文件
```

## 功能设计

### 1. 服务端功能（FastAPI后端）

#### 1.1 核心API接口

- `GET /api/version/check` - 检查版本更新
- `GET /api/version/info/{version}` - 获取版本详细信息
- `GET /api/version/download/{version}` - 下载更新包
- `GET /api/version/changelog/{version}` - 获取更新日志

#### 1.2 版本管理功能

- 版本信息存储和管理
- 更新包文件管理
- 版本比较逻辑
- 更新日志管理

#### 1.3 文件服务功能

- 更新包下载服务
- 断点续传支持
- 文件完整性校验（SHA256）

### 2. 客户端功能（PyQt5前端）

#### 2.1 主应用程序

- 简单的PyQt5界面，显示当前版本
- 手动检查更新按钮
- 启动时自动检查更新
- 应用基本功能（计数器演示）

#### 2.2 更新管理器

- 版本检查逻辑
- 更新流程协调
- 配置管理

#### 2.3 下载管理器

- HTTP下载功能
- 断点续传支持
- 进度回调
- 文件校验

#### 2.4 安装器

- 备份当前版本
- 解压更新包
- 文件替换
- 回滚机制

#### 2.5 用户界面

- 更新提示对话框
- 下载进度对话框
- 简洁美观的UI设计

## 技术栈

### 服务端（完全按照您的 0902_leo_server 架构）

- **FastAPI** - Web框架（与您的start.py一致）
- **uvicorn** - ASGI服务器
- **pydantic** - 数据模型（BaseModel）
- **pathlib** - 路径处理
- **json** - 配置文件处理
- **requests** - HTTP客户端
- **HTTPException** - 异常处理

### 客户端（完全按照您的 0902_leo_client 架构）

- **PyQt5** - GUI框架
  - QtWidgets（QApplication, QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, QDialog等）
  - QtCore（Qt, QTimer, QThread, pyqtSignal等）
  - QtGui（QFont, QPixmap, QIcon等）
- **qfluentwidgets** - 现代UI组件（可选，与您的app.py保持一致）
  - PrimaryPushButton, PushButton, LineEdit等
- **requests** - HTTP客户端（复用您的api_client.py逻辑）
- **urllib3** - HTTP工具库
- **threading** - 多线程支持
- **time** - 时间处理
- **os/sys** - 系统操作
- **zipfile** - 压缩包处理
- **hashlib** - 文件校验

## 测试场景设计

### 场景1：正常更新流程

1. 启动客户端应用（v1.0.0）
2. 自动检查更新，发现新版本（v1.1.0）
3. 显示更新对话框，用户确认更新
4. 下载更新包，显示进度
5. 自动安装更新，重启应用
6. 应用启动后显示新版本（v1.1.0）

### 场景2：手动检查更新

1. 用户点击"检查更新"按钮
2. 显示检查结果（有更新/无更新）
3. 如有更新，执行更新流程

### 场景3：下载中断恢复

1. 开始下载更新包
2. 中途取消或网络中断
3. 重新启动下载，支持断点续传

### 场景4：更新失败回滚

1. 下载完成，开始安装
2. 安装过程中出现错误
3. 自动回滚到原版本

## 版本演示内容

### v1.0.0（初始版本）

- 基本的PyQt5窗口
- 显示版本号：v1.0.0
- 简单的计数器功能（点击按钮+1）
- 检查更新按钮
- 窗口标题：测试应用 v1.0.0

### v1.1.0（更新版本）

- 保持基本功能
- 版本号更新为：v1.1.0
- 新增功能：计数器可以-1
- UI颜色主题改变（蓝色→绿色）
- 窗口标题：测试应用 v1.1.0
- 添加"关于"对话框

## 配置文件设计

### 服务端配置（server/config.json）

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 8000
  },
  "versions": {
    "latest": "1.1.0",
    "supported": ["1.0.0", "1.1.0"],
    "force_update_from": "0.9.0"
  },
  "releases_path": "./releases"
}
```

### 客户端配置（client/config/update_config.json）

```json
{
  "update_server": {
    "base_url": "http://127.0.0.1:8000",
    "api_version": "v1",
    "timeout": 30
  },
  "check_settings": {
    "auto_check": true,
    "check_interval": 86400,
    "check_on_startup": true,
    "beta_updates": false
  },
  "download_settings": {
    "parallel_downloads": 3,
    "chunk_size": 8192,
    "retry_count": 3,
    "verify_ssl": false
  },
  "install_settings": {
    "backup_enabled": true,
    "backup_count": 3,
    "auto_restart": true,
    "rollback_on_failure": true
  }
}
```

## 实现重点

### 1. 简化但完整

- 保持核心更新功能完整性
- 简化非核心业务逻辑
- 易于理解和测试

### 2. 本地测试友好

- 服务端和客户端都在本地运行
- 使用本地文件系统存储
- 快速的测试循环

### 3. 可视化效果好

- 清晰的进度显示
- 美观的对话框设计
- 直观的版本变化演示

### 4. 错误处理完善

- 网络错误处理
- 文件操作错误处理
- 用户友好的错误提示

## 使用说明

### 启动测试

1. 先启动服务端：`python server/start.py`（与您的项目启动方式一致）
2. 再启动客户端：`python client/app.py`（与您的项目启动方式一致）
3. 客户端会自动检查更新

### 模拟更新

1. 服务端预置v1.0.0和v1.1.0两个版本
2. 客户端初始为v1.0.0
3. 启动后会检测到v1.1.0更新
4. 用户可以体验完整更新流程

### 测试断点续传

1. 开始下载更新包
2. 中途关闭客户端
3. 重新启动客户端
4. 继续之前的下载

## 预期效果

通过这个测试项目，您将能够：

1. **理解更新机制** - 看到完整的在线更新流程
2. **验证方案可行性** - 测试各种更新场景
3. **学习实现细节** - 了解每个组件的作用
4. **为实际项目做准备** - 为Kuzflow集成更新功能提供参考

这个测试项目将作为方案1的完整演示，帮助您更好地理解在线更新的实现原理和技术细节。
